# 活动消息中心 - API 接口文档

## 概述

活动消息中心用于向用户推送活动通知、功能更新等消息，支持图文混排、标签分类、已读状态管理。

**Base URL:** `http://122.51.127.61:8080/api`

---

## 数据库设计

### 1. 活动消息表 (activity_messages)

```sql
CREATE TABLE activity_messages (
    id VARCHAR(36) PRIMARY KEY,          -- 消息ID (UUID)
    title VARCHAR(200) NOT NULL,          -- 标题
    content TEXT,                         -- 内容描述
    image_url VARCHAR(500),               -- 图片URL (可选)
    tag VARCHAR(50),                      -- 标签，如 "新功能"、"活动"
    link_type VARCHAR(20) DEFAULT 'none', -- 链接类型: none/internal/webview
    link_url VARCHAR(500),                -- 跳转链接 (可选)
    is_active BOOLEAN DEFAULT TRUE,       -- 是否有效/上线
    created_at DATETIME DEFAULT NOW(),    -- 创建时间
    expire_at DATETIME,                   -- 过期时间 (可选，null表示永不过期)
    sort_order INT DEFAULT 0              -- 排序权重，越大越靠前
);
```

### 2. 用户已读记录表 (user_read_messages)

```sql
CREATE TABLE user_read_messages (
    user_id VARCHAR(36) NOT NULL,         -- 用户ID
    message_id VARCHAR(36) NOT NULL,      -- 消息ID
    read_at DATETIME DEFAULT NOW(),       -- 阅读时间
    PRIMARY KEY (user_id, message_id),
    FOREIGN KEY (message_id) REFERENCES activity_messages(id) ON DELETE CASCADE
);
```

---

## API 接口

### 1. 获取活动消息列表

获取所有有效的活动消息，按时间倒序排列，包含当前用户的已读状态。

**请求**

```
GET /api/activity/messages
Authorization: Bearer {token}
```

**查询参数**

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| page | int | 否 | 1 | 页码 |
| pageSize | int | 否 | 20 | 每页数量，最大50 |

**响应**

```json
{
    "code": 200,
    "message": "success",
    "data": {
        "unreadCount": 3,
        "messages": [
            {
                "id": "msg_001",
                "title": "新的一天从 04:00 开始",
                "content": "为了完整记录你的深夜学习，我们已将每日数据刷新时间延后至凌晨4点。\n\n升级到 V5.9.17 以上即可体验，不升级的话，则仍在 24 点结算。\n（鸿蒙设备需升级到 V5.8.35 以上）",
                "imageUrl": null,
                "tag": "新功能",
                "linkType": "none",
                "linkUrl": null,
                "isRead": false,
                "createdAt": "2024-12-03T19:55:00"
            },
            {
                "id": "msg_002",
                "title": "冲刺季打卡挑战开始报名啦！！",
                "content": "年底最后一波冲刺，和好友一起坚持！\n轻轻松松赢酷币，戳我报名 >>>",
                "imageUrl": "https://example.com/images/activity_banner.png",
                "tag": "打卡挑战",
                "linkType": "webview",
                "linkUrl": "https://example.com/activity/challenge",
                "isRead": true,
                "createdAt": "2024-11-13T22:34:00"
            }
        ],
        "total": 10,
        "page": 1,
        "pageSize": 20
    }
}
```

**错误响应**

| code | message | 说明 |
|------|---------|------|
| 401 | 未授权 | Token无效或过期 |
| 500 | 服务器错误 | 服务器内部错误 |

---

### 2. 获取未读消息数量

用于首页/我的页面显示未读红点。

**请求**

```
GET /api/activity/unread-count
Authorization: Bearer {token}
```

**响应**

```json
{
    "code": 200,
    "message": "success",
    "data": {
        "unreadCount": 3
    }
}
```

---

### 3. 标记单条消息已读

用户点击/查看消息后调用。

**请求**

```
POST /api/activity/messages/{messageId}/read
Authorization: Bearer {token}
```

**路径参数**

| 参数 | 类型 | 说明 |
|------|------|------|
| messageId | String | 消息ID |

**响应**

```json
{
    "code": 200,
    "message": "success",
    "data": null
}
```

**错误响应**

| code | message | 说明 |
|------|---------|------|
| 404 | 消息不存在 | messageId无效 |

---

### 4. 标记全部已读

一键已读所有未读消息。

**请求**

```
POST /api/activity/messages/read-all
Authorization: Bearer {token}
```

**响应**

```json
{
    "code": 200,
    "message": "success",
    "data": {
        "readCount": 5
    }
}
```

---

### 5. 获取消息详情（可选）

获取单条消息的完整内容。

**请求**

```
GET /api/activity/messages/{messageId}
Authorization: Bearer {token}
```

**路径参数**

| 参数 | 类型 | 说明 |
|------|------|------|
| messageId | String | 消息ID |

**响应**

```json
{
    "code": 200,
    "message": "success",
    "data": {
        "id": "msg_001",
        "title": "新的一天从 04:00 开始",
        "content": "完整的消息内容...",
        "imageUrl": null,
        "tag": "新功能",
        "linkType": "none",
        "linkUrl": null,
        "isRead": true,
        "createdAt": "2024-12-03T19:55:00"
    }
}
```

---

## 数据模型

### ActivityMessage

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | String | 是 | 消息唯一ID |
| title | String | 是 | 消息标题，最大200字符 |
| content | String | 否 | 消息内容，支持换行符`\n` |
| imageUrl | String | 否 | 图片URL，为null时不显示图片 |
| tag | String | 否 | 标签文字，如"新功能"、"活动"，为null时不显示标签 |
| linkType | String | 是 | 点击行为类型 |
| linkUrl | String | 否 | 跳转地址，linkType为none时可为null |
| isRead | Boolean | 是 | 当前用户是否已读 |
| createdAt | String | 是 | 创建时间，ISO 8601格式 |

### linkType 枚举值

| 值 | 说明 |
|------|------|
| none | 无跳转，点击无反应或展开详情 |
| internal | App内页面跳转，linkUrl为路由路径 |
| webview | 打开内置WebView，linkUrl为网页地址 |

---

## 后端实现建议

### 查询逻辑

```sql
-- 获取消息列表（带已读状态）
SELECT 
    m.*,
    CASE WHEN r.user_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_read
FROM activity_messages m
LEFT JOIN user_read_messages r 
    ON m.id = r.message_id AND r.user_id = ?
WHERE m.is_active = TRUE 
    AND (m.expire_at IS NULL OR m.expire_at > NOW())
ORDER BY m.sort_order DESC, m.created_at DESC
LIMIT ? OFFSET ?;

-- 获取未读数量
SELECT COUNT(*) AS unread_count
FROM activity_messages m
LEFT JOIN user_read_messages r 
    ON m.id = r.message_id AND r.user_id = ?
WHERE m.is_active = TRUE 
    AND (m.expire_at IS NULL OR m.expire_at > NOW())
    AND r.user_id IS NULL;
```

### 标记已读逻辑

```sql
-- 标记单条已读（使用 INSERT IGNORE 避免重复）
INSERT IGNORE INTO user_read_messages (user_id, message_id, read_at)
VALUES (?, ?, NOW());

-- 标记全部已读
INSERT IGNORE INTO user_read_messages (user_id, message_id, read_at)
SELECT ?, m.id, NOW()
FROM activity_messages m
LEFT JOIN user_read_messages r 
    ON m.id = r.message_id AND r.user_id = ?
WHERE m.is_active = TRUE 
    AND (m.expire_at IS NULL OR m.expire_at > NOW())
    AND r.user_id IS NULL;
```

---

## 测试数据

```sql
-- 插入测试数据
INSERT INTO activity_messages (id, title, content, image_url, tag, link_type, link_url, created_at) VALUES
('msg_001', '新的一天从 04:00 开始', '为了完整记录你的深夜学习，我们已将每日数据刷新时间延后至凌晨4点。\n\n升级到 V5.9.17 以上即可体验，不升级的话，则仍在 24 点结算。', NULL, '新功能', 'none', NULL, '2024-12-03 19:55:00'),
('msg_002', '复习机制更新提醒', '为了提高复习效率，减少复习压力。新版本新增了「新学单词 - 次日仅复习错词」的复习方式。\n如需应用，可前往「学习设置」配置。', NULL, NULL, 'internal', '/settings', '2024-07-26 19:58:00'),
('msg_003', '冲刺季打卡挑战开始报名啦！！', '年底最后一波冲刺，和好友一起坚持！\n轻轻松松赢酷币，戳我报名 >>>', 'https://example.com/banner.png', '打卡挑战', 'webview', 'https://example.com/activity', '2024-11-13 22:34:00');
```
